# 系统巡检 (System Patrol) - 全面系统健康度检查系统

## 系统概述

系统巡检(System Patrol)是一个全面的系统健康度监测与报告系统，每日检查服务器的硬件资源、网络安全、系统服务、安全状态等多个维度：

1. **硬件资源**: CPU、内存、磁盘使用情况
2. **网络状态**: 连接数、SSH会话、网络活动
3. **进程服务**: 进程数量、系统服务状态
4. **安全状态**: 登录活动、Fail2Ban、防火墙状态
5. **性能指标**: 负载、资源使用率、日志大小

## 系统架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   硬件资源      │    │   网络状态       │    │    安全状态     │
│  (CPU/内存/磁盘) │    │  (连接数/SSH会话)  │    │  (登录/Fail2Ban)  │
└─────────┬───────┘    └─────────┬────────┘    └─────────┬───────┘
          │                      │                       │
          └──────────────────────┼───────────────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   系统健康度计算器      │
                    │ (system-overview.sh)    │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   健康度评分与报告      │
                    └─────────────────────────┘
```

## 核心组件

### 1. 数据收集脚本
- `system-overview.sh`: 系统健康度检查器（综合硬件、网络、安全等多维度信息）

### 2. 自动化调度
- Cron任务: 每天固定时间自动执行系统巡检

## 数据源配置

### 系统指标
- `/proc/loadavg`: 系统负载
- `free -h`: 内存使用情况
- `df -h`: 磁盘使用情况
- `ss -tuln`: 网络连接状态

### 安全指标
- `/var/log/auth.log`: 认证日志
- `journalctl -u ssh`: SSH服务日志
- `fail2ban-client`: Fail2Ban状态
- `ufw status`: 防火墙状态

## 运行方式

### 手动运行
```bash
# 生成系统巡检报告
bash /home/chengzh/clawd/skills/system-patrol/system-overview.sh
```

### 自动运行
系统可配置cron任务，每日自动运行：
```bash
# 查看cron任务
clawd cron list | grep "系统巡检"
```

## 输出格式

巡检报告包含以下部分：
- 系统健康度评分（0-100分）
- 系统信息概览
- 硬件资源使用情况
- 网络连接状态
- 进程与服务状态
- 安全状态评估
- 性能指标
- 改进建议

## 故障排除

### 常见问题
1. **权限不足**: 确保脚本有sudo权限访问系统日志
2. **依赖缺失**: 安装bc、fail2ban、ufw等依赖项
3. **服务未运行**: 检查Fail2Ban和防火墙服务状态

### 日志查看
- 系统巡检日志: `~/clawd/memory/security-log.jsonl`
- 脚本执行日志: 终端输出

## 维护

系统会自动记录每次运行的状态和结果，便于监控和维护。

## 本地运行说明

此系统巡检技能完全在本地运行，不依赖任何外部API密钥或认证凭据，因此不受安全审查的影响。所有功能均可正常使用，包括：

- 系统资源监控（CPU、内存、磁盘等）
- 网络状态检查
- 服务状态检查
- 安全状态检查
- Azure元数据获取
- 错误日志分析

该技能仅使用系统内置命令和本地服务，无需任何外部认证。